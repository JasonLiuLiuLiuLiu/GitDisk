# å¸¦ä½ ä»ä¸ä¸€æ ·çš„è§’åº¦äº†è§£å¤šçº¿ç¨‹

æœ€è¿‘åœ¨æ€§èƒ½è°ƒè¯•æ—¶,å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡,æˆ‘æŠŠä»£ç ç®€åŒ–åå¦‚ä¸‹.

``` C#
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Start...");
            DoSomething();
            Console.WriteLine("Ending...");
            Console.ReadLine();
        }

        static void DoSomething()
        {
            var sum="";
            for (int i = 2; i < int.MaxValue; i++)
            {
                sum += "s";
            }
            Console.WriteLine(sum.Length);
        }
    }
```

å¯ä»¥çœ‹åˆ°,éå¸¸ç®€å•çš„ä¸€æ®µä»£ç ,å½“æˆ‘ç”¨Windowsçš„æ€§èƒ½ç›‘æµ‹å·¥å…·æ¥ç›‘æµ‹æ¯ä¸ªå¤„ç†å™¨çš„ä½¿ç”¨ç‡æ—¶,å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡.

![](https://disk.iblogs.site/pic/ThreadInDotnet/PerformaceMonitor.png)  

æˆ‘ç”µè„‘æ˜¯å››æ ¸çš„I7å¤„ç†å™¨,æ‰§è¡Œä»¥ä¸Šä»£ç å,å´åªæœ‰å¤„ç†å™¨2ä¸€ç›´å¤„ç†ä¸€ä¸ªæ¯”è¾ƒé«˜çš„å ç”¨ç‡,è€Œå…¶ä»–çš„ä¸‰ä¸ªåˆ™å¤„äºä¸€ä¸ª"æ‘¸é±¼æ··æ—¥å­"çš„çŠ¶æ€,å¤„ç†å™¨1åˆ™æ›´è¿‡åˆ†,ä½ æ˜¯ç¡ç€äº†å—?  

![](https://disk.iblogs.site/pic/ThreadInDotnet/moyu.gif)  

åŒä¸€å°ç”µè„‘ä¸Šçš„å¤„ç†å™¨,éš¾é“å¤§å®¶ä¸æ˜¯æœ‰ç¦åŒäº«,æœ‰éš¾åŒå½“çš„å—? ä¸ºä»€ä¹ˆå…¶ä»–å‡ ä¸ªå¤„ç†å™¨å°±å¿å¿ƒçœ‹ç€å¤„ç†å™¨2æ°´æ·±ç«çƒ­å‘¢?

ç„¶å,æˆ‘å°±å’Œè¿™ä¸ªé—®é¢˜æ­»ç£•ä¸Šäº†,æ¶è¡¥äº†ä¸€äº›æ“ä½œç³»ç»Ÿä¸å¤šçº¿ç¨‹çš„çŸ¥è¯†,ç°åœ¨æŠŠä¸€å†™çŸ¥è¯†ç‚¹ä¸²èµ·æ¥,åˆ†äº«ç»™å¤§å®¶.

## åˆ†çº§ä¿æŠ¤åŸŸ

ç”µè„‘æ“ä½œç³»ç»Ÿæä¾›ä¸åŒçš„èµ„æºè®¿é—®çº§åˆ«ã€‚åœ¨è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ï¼ŒRingsæ˜¯ç”±ä¸¤ä¸ªæˆ–æ›´å¤šçš„ç‰¹æƒæ€ç»„æˆã€‚åœ¨ä¸€äº›ç¡¬ä»¶æˆ–è€…å¾®ä»£ç çº§åˆ«ä¸Šæä¾›ä¸åŒç‰¹æƒæ€æ¨¡å¼çš„CPUæ¶æ„ä¸Šï¼Œä¿æŠ¤ç¯é€šå¸¸éƒ½æ˜¯ç¡¬ä»¶å¼ºåˆ¶çš„ã€‚Ringsæ˜¯ä»æœ€é«˜ç‰¹æƒçº§ï¼ˆé€šå¸¸è¢«å«ä½œ0çº§ï¼‰åˆ°æœ€ä½ç‰¹æƒçº§ï¼ˆé€šå¸¸å¯¹åº”æœ€å¤§çš„æ•°å­—ï¼‰æ’åˆ—çš„ã€‚åœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸­ï¼ŒRing 0æ‹¥æœ‰æœ€é«˜ç‰¹æƒï¼Œå¹¶ä¸”å¯ä»¥å’Œæœ€å¤šçš„ç¡¬ä»¶ç›´æ¥äº¤äº’ï¼ˆæ¯”å¦‚CPUï¼Œå†…å­˜ï¼‰ã€‚åœ¨Windowsä¸­, User Space,ä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±å®‰è£…çš„é‚£äº›åº”ç”¨ç¨‹åºå¤„ç†Ring 3,è€Œç³»ç»Ÿå†…æ ¸å°±åœ¨Ring 0.

![](https://disk.iblogs.site/pic/ThreadInDotnet/Priv_rings.svg)  

å¯¹äºè¿™ä¸ªé—®é¢˜,ä¸¾ä¸ªä¾‹å­,å¤§å®¶å°±å¥½ç†è§£äº†.  
é’±ä¸æ˜¯ä¸‡èƒ½çš„,ä½†æ²¡é’±æ˜¯ä¸‡ä¸‡ä¸èƒ½çš„,æ‰€ä»¥é’±æ˜¯ä¸€ä¸ªå®¶åº­çš„é‡ä¸­ä¹‹é‡,å®¶é‡Œè€å©†å‘¢ä¸ºäº†è¿™ä¸ªå®¶çš„é•¿æ²»ä¹…å®‰,æŒæ¡å®¶é‡Œçš„è´¢æ”¿å¤§æƒ,æŠŠå®¶é‡Œçš„å°é‡‘åº“å®ˆå¾—æ­»æ­»çš„,ä½†è¿™å°±æ„å‘³ç€æˆ‘æ²¡é’±èŠ±äº†å—?å½“ç„¶ä¸æ˜¯,å’Œè€å©†å¤§äººç”¨æ­£å½“ç†ç”±ç”³è¯·ä¸å°±å®Œäº‹äº†?ğŸ˜‚  
ç”³è¯·é€šè¿‡ä¹‹å,è€å©†å¤§äººæ˜¯å…è®¸æˆ‘ç›´æ¥ä¼¸æ‰‹å»å®¶é‡Œå°é‡‘åº“æ‹¿é’±å—? é‚£å½“ç„¶ä¸æ˜¯,å¦‚æœæˆ‘ä¸€æŠ“ä¸€å¤§æŠŠå°±å±é™©äº†,æ‰€ä»¥è¿˜å¾—ç»è¿‡å¥¹çš„æ‰‹ä»å°é‡‘åº“æ‹¿é’±ç»™æˆ‘.  
è¿™ä¸ªç°è±¡,æˆ‘è§‰å¾—ä¹Ÿæ˜¯ä¸€ç§åˆ†çº§ä¿æŠ¤åŸŸ,æ‰€ä»¥å‘¢,ä¹Ÿä¸€ç›´å¯¹è€å©†å¤§äººçš„è¿™ç§ä¸‡æ¶è¡Œå¾„è¡¨ç¤ºç†è§£.  

![](https://disk.iblogs.site/pic/ThreadInDotnet/æµä¸‹çœ¼æ³ª.gif)  

æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯è¿™æ ·,CPU,å†…å­˜è¿™äº›ç¡¬ä»¶æ˜¯ç”µè„‘å®‰å…¨çš„æ ¹æœ¬,æ‰€ä»¥ä¸èƒ½ç»™ç¬¬ä¸‰æ–¹è½¯ä»¶æ“ä½œæƒé™,æƒ³æ“ä½œç¡¬ä»¶,å°±é€šè¿‡ç”±Ring 0ä¸­å†…æ ¸(Kernel)æš´éœ²çš„ä¸¥æ ¼Apiè¿›è¡Œ.  

## ç”¨æˆ·çº§çº¿ç¨‹ä¸å†…æ ¸çº§çº¿ç¨‹  

çº¿ç¨‹ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§å®ç°æ–¹å¼-

* ç”¨æˆ·çº§çº¿ç¨‹ -ç”¨æˆ·æ‰˜ç®¡çº¿ç¨‹ã€‚
* å†…æ ¸çº§çº¿ç¨‹ -ä½œç”¨åœ¨å†…æ ¸ï¼ˆæ“ä½œç³»ç»Ÿæ ¸å¿ƒï¼‰ä¸Šçš„æ“ä½œç³»ç»Ÿç®¡ç†çš„çº¿ç¨‹ã€‚

![](https://disk.iblogs.site/pic/ThreadInDotnet/many_to_one.jpg)  

åœ¨ä¸Šå›¾ä¸­,User Spaceå°±å¯ä»¥ç†è§£ä¸ºæˆ‘ä¸Šä¸ªç« èŠ‚ä¸­çš„Ring 3,è€ŒKernel Spaceå°±æ˜¯Ring 0, åœ¨Ring 0ä¸­,æ˜¯å¯ä»¥ç›´æ¥æ“ä½œCPU,å†…å­˜ç­‰ç¡¬ä»¶çš„,è€ŒRing 3ä¸è¡Œ.  

ä»¥ä¸‹æ˜¯ç”¨æˆ·çº§çº¿ç¨‹ä¸å†…æ ¸çº§çº¿ç¨‹çš„å¯¹æ¯”.

| ç”¨æˆ·çº§çº¿ç¨‹                                               | å†…æ ¸çº§çº¿ç¨‹                                             |
| -------------------------------------------------------- | ------------------------------------------------------ |
| ç”¨æˆ·çº¿ç¨‹ç”±ç”¨æˆ·å®ç°ã€‚                                     | å†…æ ¸çº¿ç¨‹ç”±OSå®ç°ã€‚                                     |
| æ“ä½œç³»ç»Ÿæ— æ³•è¯†åˆ«ç”¨æˆ·çº§çº¿ç¨‹ã€‚                             | å†…æ ¸çº¿ç¨‹è¢«æ“ä½œç³»ç»Ÿè¯†åˆ«ã€‚                               |
| ç”¨æˆ·çº¿ç¨‹çš„å®ç°å¾ˆå®¹æ˜“ã€‚                                   | å†…æ ¸çº¿ç¨‹çš„å®ç°å¾ˆå¤æ‚ã€‚                                 |
| ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´æ›´å°‘ã€‚                                     | ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´æ›´é•¿ã€‚                                   |
| ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸éœ€è¦ç¡¬ä»¶æ”¯æŒã€‚                               | éœ€è¦ç¡¬ä»¶æ”¯æŒã€‚                                         |
| å¦‚æœä¸€ä¸ªç”¨æˆ·çº§åˆ«çš„çº¿ç¨‹æ‰§è¡Œé˜»æ­¢æ“ä½œï¼Œåˆ™æ•´ä¸ªè¿‡ç¨‹å°†è¢«é˜»æ­¢ã€‚ | å¦‚æœä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ‰§è¡Œé˜»æ­¢æ“ä½œï¼Œåˆ™å¦ä¸€çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚ |
| æ— æ³•ç›´æ¥å‘æŒ¥å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿                               | å¯ä»¥äº«å—å¤šå¤„ç†èµ·å¸¦æ¥çš„å¥½å¤„                             |  

å…¶ä¸­,éå¸¸é‡è¦çš„ä¸€ç‚¹,ç”¨æˆ·çº§çº¿ç¨‹æ— æ³•ç›´æ¥å‘æŒ¥å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿,éš¾é“æˆ‘ä»¬ç¼–å†™å‡ºæ¥çš„ä»£ç åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œäº†å—?è¿™å°±è¦è®²è®²ç”¨æˆ·çº§çº¿ç¨‹æ¨¡å‹.  

## ç”¨æˆ·çº§çº¿ç¨‹æ¨¡å‹  

é€šå¸¸ï¼Œå†…æ ¸çº§çº¿ç¨‹å¯ä»¥ä½¿ç”¨ä¸‰ä¸ªæ¨¡å‹ä¹‹ä¸€æ¥æ‰§è¡Œç”¨æˆ·çº§çº¿ç¨‹ã€‚

* Many-to-one  
* One-to-one  
* Many-to-many  

æ‰€æœ‰æ¨¡å‹éƒ½å°†ç”¨æˆ·çº§çº¿ç¨‹æ˜ å°„åˆ°å†…æ ¸çº§çº¿ç¨‹,ä¸€ä¸ªå†…æ ¸çº¿ç¨‹å°±åƒä¸€ä¸ªå¤„ç†å™¨,å®ƒæ˜¯ç³»ç»Ÿç¼–æ’ä»»åŠ¡çš„åŸºæœ¬å•ä½ã€‚

## Many-to-one  

å¤šå¯¹ä¸€æ¨¡å‹å°†è®¸å¤šç”¨æˆ·çº§çº¿ç¨‹æ˜ å°„åˆ°ä¸€ä¸ªå†…æ ¸çº§çº¿ç¨‹ã€‚çº¿ç¨‹ç®¡ç†æ˜¯é€šè¿‡çº¿ç¨‹åº“åœ¨ç”¨æˆ·ç©ºé—´ä¸­å®Œæˆçš„ã€‚å½“çº¿ç¨‹è¿›è¡Œé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹å°†è¢«é˜»å¡ã€‚ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å†…æ ¸ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹æ— æ³•åœ¨å¤šå¤„ç†å™¨ä¸Šå¹¶è¡Œè¿è¡Œã€‚
å¦‚æœç”¨æˆ·çº§çº¿ç¨‹åº“æ˜¯ä»¥æ“ä½œç³»ç»Ÿä¸æ”¯æŒçš„æ–¹å¼å®ç°çš„ï¼Œåˆ™å†…æ ¸çº¿ç¨‹å°†ä½¿ç”¨å¤šå¯¹ä¸€å…³ç³»æ¨¡å‹ã€‚
![](https://disk.iblogs.site/pic/ThreadInDotnet/many-to-one.png)  
å†…æ ¸å¯¹ç”¨æˆ·çº§çº¿ç¨‹ä¸å¯è§,åœ¨å®ƒçœ¼é‡Œåªæœ‰å†…æ ¸çº¿ç¨‹,è€Œåœ¨å†…æ ¸çº¿ç¨‹çš„çœ¼é‡Œ,ä¸€ä¸ªè¿›ç¨‹æ— éå°±æ˜¯ä¸€ä¸ªå¶å°”è¢«è¢«å®ƒç¿»ç‰Œçš„é»‘ç›’å­,è¿›ç¨‹è´Ÿè´£ç”¨æˆ·çº¿ç¨‹çš„è°ƒåº¦ä¸æ‰§è¡Œ.  

## One-to-one  

åœ¨è¿™ç§æ¨¡å‹ä¸‹ç”¨æˆ·çº§çº¿ç¨‹ä¸å†…æ ¸çº§çº¿ç¨‹ä¹‹é—´å­˜åœ¨ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚è¯¥æ¨¡å‹æ¯”å¤šå¯¹ä¸€æ¨¡å‹å¹¶å‘æ€§å¥½,å½“ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œé˜»å¡ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå®ƒè¿˜å…è®¸å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡Œ,æ‰€ä»¥å®ƒæ”¯æŒå¤šä¸ªçº¿ç¨‹ä»¥åœ¨å¤„ç†å™¨ä¸Šå¹¶è¡Œæ‰§è¡Œã€‚
è¯¥æ¨¡å‹çš„ç¼ºç‚¹æ˜¯åˆ›å»ºç”¨æˆ·çº¿ç¨‹éœ€è¦ç›¸åº”çš„å†…æ ¸çº¿ç¨‹,è€Œåˆ›å»ºå†…æ ¸çº¿ç¨‹å¼€é”€æ˜¯å¾ˆå¤§çš„.  
![](https://disk.iblogs.site/pic/ThreadInDotnet/one-to-one.png)   

## Many-to-many  

åœ¨å¤šå¯¹å¤šæ¨¡å‹ä¸­ï¼Œmä¸ªå†…æ ¸çº¿ç¨‹å¤„ç†nä¸ªç”¨æˆ·çº¿ç¨‹,å…¶ä¸­m < n. è¯¥æ¨¡å‹å¹¶å‘æ€§æœ€å¥½,å¹¶ä¸”ä¸ç”¨åˆ›å»ºè¿‡å¤šçš„å†…æ ¸çº¿ç¨‹,æ¶‰åŠåˆ°çš„çº¿ç¨‹åˆ‡æ¢åŒæ­¥çš„å¼€é”€ä¹Ÿæ›´å°.  
![](https://disk.iblogs.site/pic/ThreadInDotnet/many-to-many.png)  

## çœŸç›¸æµ®å‡ºæ°´é¢

.Netçš„ä»£ç ä½œä¸ºæ‰˜ç®¡ä»£ç åœ¨â€œæ‰˜ç®¡çº¿ç¨‹â€ä¸Šæ‰§è¡Œï¼Œè€Œæ‰˜ç®¡çº¿ç¨‹æ˜¯åœ¨CLRè™šæ‹Ÿæœºä¸Šæ‰§è¡Œçš„è™šæ‹Ÿçº¿ç¨‹,ä¹Ÿæ˜¯å±äºç”¨æˆ·çº§çº¿ç¨‹.

æ­£å¦‚JITç¼–è¯‘å™¨å°†â€œè™šæ‹Ÿâ€ ILæŒ‡ä»¤æ˜ å°„åˆ°åœ¨ç‰©ç†è®¡ç®—æœºä¸Šæ‰§è¡Œçš„æœ¬æœºæŒ‡ä»¤ä¸€æ ·ï¼ŒCLRçš„çº¿ç¨‹åŸºç¡€ç»“æ„ä¹Ÿå°†â€œè™šæ‹Ÿâ€æ‰˜ç®¡çº¿ç¨‹æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿæä¾›çš„å†…æ ¸çº¿ç¨‹ã€‚

è¯´åˆ°è¿™é‡Œ,æˆ‘ä»¬ä¹Ÿå·®ä¸å¤šæœ‰äº†å‰é¢æˆ‘è¯´çš„é‚£ä¸ªç°è±¡çš„ç­”æ¡ˆäº†,å¹¶éå…¶ä»–å¤„ç†å™¨ä¸æƒ³ä¸é‚£ä¸ªæ°´æ·±ç«çƒ­çš„å¤„ç†å™¨æœ‰éš¾åŒäº«,è€Œæ˜¯æˆ‘æ²¡æœ‰ä½¿ç”¨å¤šçº¿ç¨‹,æ‰€ä»¥æ‰§è¡Œçš„ç¨‹åºåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹,ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·çº¿ç¨‹æ•°ä¸º1.åªèƒ½æ˜¯one to one æ¨¡å‹,æ‰€ä»¥åªæœ‰ä¸€ä¸ªå¤„ç†å™¨èƒ½å‚ä¸å·¥ä½œ.  

æ—¢ç„¶çŸ¥é“äº†é‡Œé¢çš„åŸç†,é‚£æˆ‘ä»¬å°±å¯¹å‰æ–‡ä¸­çš„ç¨‹åºè¿›è¡Œæ”¹é€ ,åˆ›å»ºå››ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡,ä¼šä¸ä¼šæ‰€æœ‰å¤„ç†å™¨éƒ½å¿™èµ·æ¥å‘¢?  

``` c#
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Start...");
            for (var i = 0; i < 4; i++)
            {
                var td=new Thread(DoSomething);
                td.Start();
            }
            Console.WriteLine("Ending...");
            Console.ReadLine();
        }

        static void DoSomething()
        {
            var sum="";
            for (int i = 2; i < int.MaxValue; i++)
            {
                sum += "s";
            }
            Console.WriteLine(sum.Length);
        }
    }
```

å¯ä»¥çœ‹åˆ°,è¿™æ¬¡å¤§å®¶çš„æ­¥ä¼éƒ½åšåˆ°äº†æƒŠäººçš„ä¸€è‡´,å››ä¸ªå¤„ç†å™¨éƒ½è¢«è°ƒç”¨èµ·æ¥,åŠ ä¸Šä¸»çº¿ç¨‹,è¿™é‡Œè‡³å°‘æœ‰äº”ä¸ªç”¨æˆ·çº¿ç¨‹,æ‰€ä»¥è¿™é‡Œåº”è¯¥æ˜¯many to manyçš„æ¨¡å‹äº†.  

![](https://disk.iblogs.site/pic/ThreadInDotnet/MutilThread.png)   

 
å‚è€ƒèµ„æ–™:  
https://en.wikipedia.org/wiki/Protection_ring  
https://stackoverflow.com/questions/15093510/whats-c-sharp-threading-type  
https://github.com/dotnet/coreclr/blob/master/Documentation/botr/  threading.md#clr-threading-overview  

